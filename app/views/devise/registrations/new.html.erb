<h2>Sign up</h2>

<%= form_for(resource, :as => resource_name, :url => registration_path(resource_name)) do |f| %>
  <%= devise_error_messages! %>

  <% if resource_name =~ /user/ %>
    <%= f.label :foraging_range %>
    <input type="text" value="Zoom To..." onclick="this.value='';" name="address" id="address">
    <button type="button" onclick="recenter_map_to_address();return false;">Go</button>
    <div id="map" style="width:500px; height:300px;"></div>
    <% content_for :page_scripts do %>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=drawing&amp;sensor=false"></script>a
<script src="/assets/wicket.src.js" type="text/javascript"></script>
<script src="/assets/wicket-gmap3.src.js" type="text/javascript"></script>
<script type="text/javascript">

overlay = undefined;
geocoder = undefined;
map = undefined;

function initialize() {
  var mapOptions = {
    center: new google.maps.LatLng(-34.397, 150.644),
    zoom: 8,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };

  map = new google.maps.Map(document.getElementById('map'),mapOptions);

  var drawingManager = new google.maps.drawing.DrawingManager({
    drawingMode: google.maps.drawing.OverlayType.MARKER,
    drawingControl: true,
    drawingControlOptions: {
      position: google.maps.ControlPosition.TOP_CENTER,
      drawingModes: [
        //google.maps.drawing.OverlayType.MARKER,
        //google.maps.drawing.OverlayType.CIRCLE, // Wicket library doesn't support Circle deconstruction (yet)
        google.maps.drawing.OverlayType.POLYGON,
        //google.maps.drawing.OverlayType.POLYLINE,
        google.maps.drawing.OverlayType.RECTANGLE
      ]
    },
    polygonOptions: {
      clickable: true,
      editable: true,
      zIndex: 1
    },
    rectangleOptions: {
      clickable: true,
      editable: true,
      zIndex: 1
    },
    circleOptions: {
      clickable: true,
      editable: true,
      zIndex: 1
    }
  });

  google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
    if(overlay != undefined){
      overlay.setMap(null);
    }
    overlay = event.overlay;
    var wkt = new Wkt.Wkt();
    wkt.fromObject(overlay);
    document.getElementById('user_range').value = wkt.write();
  });

  geocoder = new google.maps.Geocoder();

  drawingManager.setMap(map);
}
google.maps.event.addDomListener(window, 'load', initialize);

function recenter_map_to_address() {
  geocoder.geocode( { 'address': $("#address").val() }, function(results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      map.setZoom(13)
      map.panTo(results[0].geometry.location);
      var cross = new google.maps.Marker({
        icon: '/cross.png',
        position: results[0].geometry.location,
        map: map,
        draggable: false
      });
    } else {
      alert("Geocode was not successful for the following reason: " + status);
    }
  });
}

</script>
    <% end %>
  <% end %>

  <%= f.hidden_field :range %>

  <div><%= f.label :email %><br />
  <%= f.email_field :email %></div>

  <div><%= f.label :password %><br />
  <%= f.password_field :password %></div>

  <div><%= f.label :password_confirmation %><br />
  <%= f.password_field :password_confirmation %></div>

  <div><%= f.submit "Sign up" %></div>
<% end %>

<%= render "devise/shared/links" %>
