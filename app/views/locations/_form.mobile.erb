<div id="mobile-form">

<% if @location.errors.any? %>
<ul data-role="listview" data-theme="e">
 <% @location.errors.full_messages.each do |msg| %>
 <li>Error: <%= msg %>
 <% end %>
</ul>
<% end %>

<!-- Source Form -->
<%= form_for(@location,{:html => {'data-ajax' => 'false'}}) do |f| %>
  <%= f.hidden_field :id %>
  <%= f.hidden_field(:client, :value => 'mobile') %>
  <%= hidden_field_tag(:create_another, '1') %>

<div data-role="fieldcontain">
  <!-- Type -->
  <fieldset data-role="controlgroup">
    <legend>Type<br>
    <span class="subtext">Choose from the dropdown list, submitting new names only if appropriate choices do not already exist.</span><br>
    </legend>
   <div class="field" id="types">
    <%= hidden_field_tag('types', @location.locations_types.collect{ |lt| lt.type.nil? ? lt.type_other : lt.type.name }.join(","), :id=>"typeselect2") %>
   </div>
  </fieldset>
  <br>  
  
  <!-- Location -->
  <fieldset data-role="controlgroup">
  <legend>Location<br>
  <span class="subtext">Determined from your current location (when available) or a marker you placed. Adjust the location by moving the map marker.</span>
  </legend>
  <%= f.text_field :lat, :size => 12, :value => @lat, 'data-inline' => 'true' %> (Latitude)<br>
  <%= f.text_field :lng, :size => 12, :value => @lng, 'data-inline' => 'true' %> (Longitude)
  <a href="#" onclick="update_marker_latlng();" data-role="button" data-ajax="false" data-mini="true" data-inline="true">Move marker to coordinates</a>
  </fieldset>
  <br>
  
  <!-- Address -->
  <% if @current_action == "new" or @current_action == "create" %>
  <fieldset data-role="controlgroup">
    <legend>Address<br />
    <span class="subtext">Address can be used to quickly position the marker. Adjust as needed before submitting.</span>
    </legend>
    <%= f.text_area :address, :size => "40x2" %><br>
    <a href="#" onclick="update_marker_address();" data-role="button" data-ajax="false" data-mini="true" data-inline="true">Move marker to address</a>
  </fieldset>
  <% end %>
  <br>
  
  <!-- Author (new) -->
  <% if @current_action == "new" %>
  	<fieldset data-role="controlgroup">
			<legend>Author<br />
			<span class="subtext">Displayed on map. Leave blank if you prefer to remain anonymous.</span><br />
			</legend>
			<% if !user_signed_in? or (user_signed_in? and current_user.add_anonymously?) %>
				<%= f.text_field :author, :size => 40 %>
			<% elsif user_signed_in? and !current_user.add_anonymously? %>
				<%= f.text_field :author, :value => current_user.name, :size => 40 %>
			<% end %>
  	</fieldset>
  <% end %>
  
  <!-- Author (edit: admin only) -->
  <% if @current_action == "edit" and (user_signed_in? and current_user.is? :admin) %>
  	<fieldset data-role="controlgroup">
			<legend>Author<br />
			<span class="subtext">Displayed on map. Leave blank if you prefer to remain anonymous.</span><br />
			</legend>
			<%= f.text_field :author, :size => 40 %>
  	</fieldset>
  <% end %>
  
  <br>
  <!-- Description -->
  <fieldset data-role="controlgroup">
    <legend>Description<br>
    <span class="subtext">Location details, access issues, plant health...</span><br>
    </legend>
    <%= f.text_area :description, :size => "50x10" %>
  </fieldset>
  <br>
  
  <!-- Season -->
  <fieldset data-role="controlgroup">
    <legend>Season<br />
    <span class="subtext">When can the source be harvested? Leave blank if you don't know.</span><br>
    </legend>
    <%= f.select(:season_start,[['From:','']] + Location::Months.collect{ |m| [m,Location::Months.index(m)] }) %>
    <%= f.select(:season_stop,[['To:','']] + Location::Months.collect{ |m| [m,Location::Months.index(m)] }) %>
    <label><%= f.check_box(:no_season) %> No Season</label>
  </fieldset>
  <br>
  
  <!-- Access -->
  <fieldset data-role="controlgroup">
    <legend>Access<br />
    <span class="subtext">Access status of this source. Leave blank if you don't know.</span>
    </legend>
    <%= f.select(:access,Location::AccessModes.collect{ |r| [r,Location::AccessModes.index(r)] },:include_blank => true) %>
  </fieldset>
  
  <!-- Unverified -->
  <fieldset data-role="controlgroup">
    <legend>Unverified<br>
    <span class="subtext">If you doubt the existence, location, or identity of this source.</span>
    </legend>
    <label><%= f.check_box(:unverified) %> Unverified</label>
  </fieldset>
  <br>  

  <% if @current_action == "new" %>
  <!-- Quality Rating -->
  <fieldset data-role="controlgroup">
    <legend>Quality Rating<br />
    <span class="subtext">Rate the tastiness of this source (if applicable)</span>
    </legend>
    <fieldset data-role="controlgroup" data-type="horizontal" >
    <% Location::Ratings.each_index{ |r| %>
    <%= radio_button_tag("quality_rating",r) %>
    <label for="quality_rating_<%= r %>"><%= Location::Ratings[r] %></label>

    <% } %>
    </fieldset>
  </fieldset>
  <br>
  <!-- Yield Rating -->
  <fieldset data-role="controlgroup">
    <legend>Yield Rating<br />
    <span class="subtext">Rate the productivity of this source (if applicable)</span>
    </legend>
    <fieldset data-role="controlgroup" data-type="horizontal" >
    <% Location::Ratings.each_index{ |r| %>
    <%= radio_button_tag("yield_rating",r) %>
    <label for="yield_rating_<%= r %>"><%= Location::Ratings[r] %></label>

    <% } %>
    </fieldset>
  </fieldset>
  <br>
  <!-- Fruiting -->
  <fieldset data-role="controlgroup">
    <legend>Fruiting status<br />
    <span class="subtext">What is the fruit doing right now? (if applicable)</span>
    </legend>
    <fieldset data-role="controlgroup" data-type="horizontal" >
    <% Location::Fruiting.each_index{ |r| %>
    <%= radio_button_tag("fruiting",r) %>
    <label for="fruiting_<%= r %>"><%= Location::Fruiting[r] %></label>

    <% } %>
    </fieldset>
  </fieldset>
  <br>
  <!-- Date -->
  <fieldset data-role="controlgroup">
    <legend>Visited On<br />
    <span class="subtext">Date of the reported fruiting status (if not today)</span>
    </legend>
    <%= text_field_tag(:observed_on) %>
  </fieldset>
  <% end %>
  
  <br>
  <!-- Submit -->
    <!-- Captcha -->
    <div id="captcha">
    <%= recaptcha_tags(:display => {:theme => 'clean'}) unless user_signed_in? %>
    </div>
    <br><br>
    <%= f.submit("Submit", 'data-ajax' => 'false') %>
  
<% end %>

</div>

<% content_for :form_scripts do %>
<script type="text/javascript" charset="utf-8">
jQuery(document).ready(function(){
  $("#observed_on").datepicker();
  // Type selector
  $('#typeselect2').select2({
        tokenSeparators: [","],width:'100%',
    tags:[<%= raw Type.order("name").collect{ |t| t.scientific_name.nil? ? '"'+t.name+'"' : '"'+t.name+" ["+t.scientific_name+"]"+'"' }.join(",") %>]
  });
  $("#typeselect2").select2("container").find("ul.select2-choices").sortable({
    containment: 'parent',
    start: function() { $("#typeselect2").select2("onSortStart"); },
    update: function() { $("#typeselect2").select2("onSortEnd"); }
        });

  // Hide the checkboxes since they are overwritten by jQuery mobile
  $("#location_no_season").hide();
  $("#location_unverified").hide();

});
</script>
<% end %>
